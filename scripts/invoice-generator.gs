/**
 * â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 * ğŸ“„ Google Apps Script - è«‹æ±‚æ›¸PDFè‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«
 * â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 *
 * ã€ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ©Ÿèƒ½ã€‘
 * - Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è«‹æ±‚æ›¸PDFã‚’è‡ªå‹•ç”Ÿæˆ
 * - Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ä½œæ¥­æ™‚é–“ã‚’è‡ªå‹•å–å¾—
 * - PDFã‚’Google Driveã«ä¿å­˜
 * - è«‹æ±‚æ›¸ã‚’ãƒ¡ãƒ¼ãƒ«ã§è‡ªå‹•é€ä¿¡
 *
 * ã€ä¸»ãªç‰¹å¾´ã€‘
 * âœ“ ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆåˆ—ã®é †ç•ªã¯è‡ªç”±ï¼‰
 * âœ“ æ—¥ä»˜ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
 * âœ“ ãƒãƒƒãƒå‡¦ç†å¯¾å¿œï¼ˆè¤‡æ•°ã®è«‹æ±‚æ›¸ã‚’ä¸€æ‹¬ä½œæˆï¼‰
 * âœ“ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å‡¦ç†ã‚’ç¶™ç¶šï¼‰
 * âœ“ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ãªã—ã§å‹•ä½œç¢ºèªå¯èƒ½ï¼‰
 *
 * ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã€‘åˆå¿ƒè€…ã®æ–¹å‘ã‘
 * 1. ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆinvoice-data.csv ã‚’å‚ç…§ï¼‰
 *    - è«‹æ±‚å…ˆæƒ…å ±ã€é …ç›®ã€é‡‘é¡ãªã©ã‚’å…¥åŠ›ã—ã¾ã™
 *
 * 2. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆinvoice-template.csv ã‚’å‚ç…§ï¼‰
 *    - {{seller_name}}ã®ã‚ˆã†ãªãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ã„ã¾ã™
 *
 * 3. ä¸‹è¨˜ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šï¼ˆå¿…é ˆï¼ï¼‰
 *    - DATA_SPREADSHEET_ID: ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ID
 *    - TEMPLATE_SPREADSHEET_ID: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ID
 *    - NOTION_API_KEY: Notion APIã‚­ãƒ¼
 *
 * 4. createInvoices() é–¢æ•°ã‚’å®Ÿè¡Œ
 *    - Google Apps Scriptã‚¨ãƒ‡ã‚£ã‚¿ã§é–¢æ•°ã‚’é¸æŠã—ã¦å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
 *
 * ã€åˆå›å®Ÿè¡Œæ™‚ã®æ³¨æ„ã€‘
 * - Google Apps ScriptãŒå„ç¨®ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆDriveã€Gmailã€Notionï¼‰ã¸ã®
 *   ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’æ±‚ã‚ã¾ã™ã€‚å¿…ãšè¨±å¯ã—ã¦ãã ã•ã„ã€‚
 */

// ============================================================================
// âš™ï¸ ç’°å¢ƒå¤‰æ•° - æœ€åˆã«ã“ã“ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼ï¼ˆå¿…é ˆï¼‰
// ============================================================================
// ã€é‡è¦ã€‘ä»¥ä¸‹ã®3ã¤ã®å¤‰æ•°ã¯å¿…ãšè¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

// ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ID
// å–å¾—æ–¹æ³•: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‹ã‚‰å–å¾—
// ä¾‹: https://docs.google.com/spreadsheets/d/ã€ã“ã“ãŒIDã€‘/edit
const DATA_SPREADSHEET_ID = "";

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ID
// å–å¾—æ–¹æ³•: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‹ã‚‰å–å¾—
// ä¾‹: https://docs.google.com/spreadsheets/d/ã€ã“ã“ãŒIDã€‘/edit
const TEMPLATE_SPREADSHEET_ID = "";

// Notion APIã‚­ãƒ¼
// å–å¾—æ–¹æ³•: https://www.notion.so/my-integrations ã§ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
// ä½œæˆå¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹ã€ŒInternal Integration Tokenã€ã‚’ã‚³ãƒ”ãƒ¼
const NOTION_API_KEY = "";

// ============================================================================
// ğŸ“‹ è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³
// ============================================================================

/**
 * ã€ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆ—æ§‹æˆã€‘
 * ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã¯ä»¥ä¸‹ã®åˆ—ãŒå¿…è¦ã§ã™ï¼ˆé †ç•ªã¯è‡ªç”±ï¼‰ï¼š
 *
 * - seller_name: è«‹æ±‚å…ˆä¼šç¤¾åï¼ˆä¾‹: æ ªå¼ä¼šç¤¾ABCï¼‰
 * - invoice_needed: è«‹æ±‚æ›¸ç”Ÿæˆãƒ•ãƒ©ã‚°ï¼ˆTRUE/FALSEï¼‰â€»TRUEã®å ´åˆã®ã¿è«‹æ±‚æ›¸ã‚’ç”Ÿæˆ
 * - seller_address: è«‹æ±‚å…ˆä½æ‰€
 * - seller_email: ãƒ¡ãƒ¼ãƒ«é€ä¿¡å…ˆã‚¢ãƒ‰ãƒ¬ã‚¹
 * - item_1_name: é …ç›®åï¼ˆä¾‹: ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°æ¥­å‹™ï¼‰
 * - item_1_price: å˜ä¾¡ï¼ˆä¾‹: æ™‚é–“å˜ä¾¡ï¼‰
 * - seller_bank_name: éŠ€è¡Œå
 * - seller_bank_type: å£åº§ç¨®åˆ¥ï¼ˆæ™®é€š/å½“åº§ï¼‰
 * - seller_bank_number: å£åº§ç•ªå·
 * - seller_bank_holder_name: å£åº§åç¾©
 * - output_folder_id: ï¼ˆå¿…é ˆï¼‰PDFã‚’ä¿å­˜ã™ã‚‹Google Driveãƒ•ã‚©ãƒ«ãƒ€ã®ID
 * - notion_user_id: Notionãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆUUIDå½¢å¼ï¼‰
 *
 * ã€è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹é …ç›®ã€‘
 * - è«‹æ±‚æ—¥: ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œæ™‚ã®æ—¥ä»˜ãŒè‡ªå‹•è¨­å®šã•ã‚Œã¾ã™
 * - PDFãƒ•ã‚¡ã‚¤ãƒ«å: YYYYMMDD_æ ªå¼ä¼šç¤¾DROXæ§˜_è«‹æ±‚æ›¸.pdf ã®å½¢å¼ã§è‡ªå‹•ç”Ÿæˆ
 */

/**
 * ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå†…ã®ã‚·ãƒ¼ãƒˆå
 * é€šå¸¸ã¯ 'Sheet1' ã§ã™ãŒã€ç•°ãªã‚‹å ´åˆã¯å¤‰æ›´ã—ã¦ãã ã•ã„
 */
const DATA_SHEET_NAME = "Sheet1";

/**
 * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå†…ã®ã‚·ãƒ¼ãƒˆå
 * é€šå¸¸ã¯ 'Sheet1' ã§ã™ãŒã€ç•°ãªã‚‹å ´åˆã¯å¤‰æ›´ã—ã¦ãã ã•ã„
 */
const TEMPLATE_SHEET_NAME = "Sheet1";

// ============================================================================
// ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡è¨­å®š
// ============================================================================

/**
 * ã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®è¨­å®šã€‘
 *
 * EMAIL_ENABLED: ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ã®æœ‰åŠ¹/ç„¡åŠ¹
 *   - true: ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’æœ‰åŠ¹ã«ã™ã‚‹
 *   - false: ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å®Œå…¨ã«ç„¡åŠ¹ã«ã™ã‚‹ï¼ˆPDFã®ã¿ä½œæˆï¼‰
 *
 * TEST_MODE: ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
 *   - true: ãƒ¡ãƒ¼ãƒ«ã‚’å®Ÿéš›ã«é€ä¿¡ã›ãšã€ãƒ­ã‚°ã ã‘å‡ºåŠ›ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
 *   - false: å®Ÿéš›ã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ï¼ˆæœ¬ç•ªç”¨ï¼‰
 *   âš ï¸ åˆã‚ã¦ä½¿ã†å ´åˆã¯ true ã«ã—ã¦ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™
 *
 * SENDER_EMAIL: é€ä¿¡è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 *   - Google Apps Scriptã‚’å®Ÿè¡Œã™ã‚‹Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 *
 * SENDER_NAME: é€ä¿¡è€…ã®è¡¨ç¤ºå
 *   - ãƒ¡ãƒ¼ãƒ«å—ä¿¡æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹é€ä¿¡è€…å
 */
const EMAIL_ENABLED = true; // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’æœ‰åŠ¹ã«ã™ã‚‹
const TEST_MODE = false; // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹ã«ã™ã‚‹ï¼ˆæœ¬ç•ªé‹ç”¨æ™‚ã¯ falseï¼‰
const SENDER_EMAIL = "koki-hata@drox-inc.com"; // é€ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
const SENDER_NAME = "æ ªå¼ä¼šç¤¾DROX"; // é€ä¿¡è€…å

// ============================================================================
// ğŸ”— Notion API è¨­å®š
// ============================================================================

/**
 * ã€Notion ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šã€‘
 *
 * Notionã‹ã‚‰ä½œæ¥­æ™‚é–“ã‚’è‡ªå‹•å–å¾—ã™ã‚‹å ´åˆã«è¨­å®šã—ã¾ã™
 *
 * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †:
 * 1. https://www.notion.so/my-integrations ã§ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
 * 2. ä½œæˆã—ãŸã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ NOTION_API_KEY ã«è¨­å®šï¼ˆä¸Šéƒ¨ã®ç’°å¢ƒå¤‰æ•°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
 * 3. Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨å…±æœ‰
 *    - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ã®å³ä¸Šã€Œ...ã€â†’ã€Œã‚³ãƒã‚¯ãƒˆã®è¿½åŠ ã€â†’ ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åã‚’é¸æŠ
 * 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®IDã‚’ NOTION_DATABASE_ID ã«è¨­å®š
 *    - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URLã‹ã‚‰å–å¾—: https://notion.so/ã€ã“ã“ãŒIDã€‘?v=...
 *
 * ã€Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å¿…é ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€‘
 * - Start Time: æ—¥ä»˜å‹ï¼ˆé–‹å§‹æ™‚åˆ»ï¼‰
 * - End Time: æ—¥ä»˜å‹ï¼ˆçµ‚äº†æ™‚åˆ»ï¼‰
 * - hours: æ•°å€¤å‹ã¾ãŸã¯ãƒ•ã‚©ãƒ¼ãƒŸãƒ¥ãƒ©å‹ï¼ˆä½œæ¥­æ™‚é–“ï¼‰
 */
const NOTION_DATABASE_ID = "25143e83afc180cfaa2bff97b74538eb"; // Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ID
const NOTION_API_VERSION = "2022-06-28"; // Notion APIã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆé€šå¸¸å¤‰æ›´ä¸è¦ï¼‰

// ============================================================================
// ğŸ”— Notion API é–¢æ•°ç¾¤
// ============================================================================

/**
 * Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒï¼ˆæ§‹é€ ï¼‰ã‚’å–å¾—ã™ã‚‹é–¢æ•°
 * ã€ç”¨é€”ã€‘ãƒ‡ãƒãƒƒã‚°æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã‚„å‹ã‚’ç¢ºèªã§ãã¾ã™
 * ã€åˆå¿ƒè€…å‘ã‘èª¬æ˜ã€‘
 * - ã“ã®é–¢æ•°ã¯ã€Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã©ã‚“ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆåˆ—ï¼‰ãŒã‚ã‚‹ã‹ã‚’èª¿ã¹ã¾ã™
 * - ä¾‹: "Start Time"ã¨ã„ã†åå‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒ"date"å‹ã§ã‚ã‚‹ã“ã¨ãªã©ã‚’ç¢ºèªã§ãã¾ã™
 *
 * @returns {Object} ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æƒ…å ±
 */
function getNotionDatabaseSchema() {
  console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
  console.log("ğŸ” [é–‹å§‹] Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒã‚’å–å¾—ã—ã¾ã™");
  console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

  try {
    // --------------------------------------------------------------------------
    // â–¼ STEP 1: APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æº–å‚™ â–¼
    // --------------------------------------------------------------------------
    // Notion APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®URLã‚’çµ„ã¿ç«‹ã¦ã¾ã™ã€‚
    // ã“ã®URLã¯ã€ã©ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æƒ…å ±ã‚’å–å¾—ã—ãŸã„ã‹ã‚’Notionã«ä¼ãˆã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
    const url = `https://api.notion.com/v1/databases/${NOTION_DATABASE_ID}`;
    console.log(`æ§‹ç¯‰ã•ã‚ŒãŸURL: ${url}`);

    // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿…è¦ãªè¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ã‚’å®šç¾©ã—ã¾ã™ã€‚
    const options = {
      method: "get", // 'get'ã¯ã€Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã€ã¨ã„ã†æ„å‘³ã®HTTPãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚
      headers: {
        // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šãƒªã‚¯ã‚¨ã‚¹ãƒˆã«é–¢ã™ã‚‹è¿½åŠ æƒ…å ±
        // Authorization: APIã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®ã€Œèªè¨¼ã‚­ãƒ¼ã€ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Notionã¯èª°ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚’è­˜åˆ¥ã—ã¾ã™ã€‚
        Authorization: `Bearer ${NOTION_API_KEY}`,
        // Notion-Version: ä½¿ç”¨ã™ã‚‹Notion APIã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚
        "Notion-Version": NOTION_API_VERSION,
      },
      // muteHttpExceptions: trueã«è¨­å®šã™ã‚‹ã¨ã€APIãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ãŸå ´åˆï¼ˆä¾‹ï¼š404 Not Foundï¼‰ã§ã‚‚
      // ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒåœæ­¢ã›ãšã€å¾Œç¶šã®ã‚³ãƒ¼ãƒ‰ã§ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
      muteHttpExceptions: true,
    };
    console.log("ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼:", options.headers);

    // --------------------------------------------------------------------------
    // â–¼ STEP 2: Notion APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ â–¼
    // --------------------------------------------------------------------------
    console.log("ğŸ“¡ Notion APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ä¸­...");
    // UrlFetchApp.fetch() ã‚’ä½¿ã£ã¦ã€å®Ÿéš›ã«Notion APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚
    const response = UrlFetchApp.fetch(url, options);
    const responseCode = response.getResponseCode();
    const responseBody = response.getContentText();
    console.log(`ğŸ“¬ Notion APIã‹ã‚‰ã®å¿œç­”ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${responseCode}`);

    // --------------------------------------------------------------------------
    // â–¼ STEP 3: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‡¦ç† â–¼
    // --------------------------------------------------------------------------
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ200ã®å ´åˆã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯æˆåŠŸã§ã™ã€‚
    if (responseCode === 200) {
      console.log("âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã®å–å¾—ã«æˆåŠŸã—ã¾ã—ãŸã€‚");
      // å¿œç­”ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONå½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¾ã™ã€‚
      const data = JSON.parse(responseBody);

      console.log("=== ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ä¸€è¦§ ===");
      // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æƒ…å ±ã‚’å–ã‚Šå‡ºã—ã€åå‰ã¨å‹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¾ã™ã€‚
      // ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã©ã®ã‚ˆã†ãªåˆ—ãŒã‚ã‚‹ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚
      for (const [propName, propConfig] of Object.entries(data.properties)) {
        console.log(`  - ğŸ“‹ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å: "${propName}", å‹: ${propConfig.type}`);
      }
      console.log("====================================");
      console.log("âœ… [å®Œäº†] getNotionDatabaseSchema() - æˆåŠŸ");
      console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
      return data.properties;
    } else {
      // 200ä»¥å¤–ã®ã‚³ãƒ¼ãƒ‰ã¯ã‚¨ãƒ©ãƒ¼ã‚’ç¤ºã—ã¾ã™ã€‚
      console.error(`âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${responseCode}`);
      console.error("--- Notionã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ START ---");
      console.error(responseBody);
      console.error("--- Notionã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ END ---");
      console.error("ğŸ’¡ ãƒ’ãƒ³ãƒˆ: NOTION_API_KEY ã¾ãŸã¯ NOTION_DATABASE_ID ãŒé–“é•ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
      return null;
    }
  } catch (error) {
    console.error("âŒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error.message);
    console.error("ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã¾ãŸã¯Google Apps Scriptã®ã‚µãƒ¼ãƒ“ã‚¹ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
    return null;
  }
}

/**
 * Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æŒ‡å®šæœŸé–“ãƒ»ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæ¥­æ™‚é–“ã‚’å–å¾—ã™ã‚‹é–¢æ•°
 * ã€æ©Ÿèƒ½ã€‘æŒ‡å®šã—ãŸæ—¥ä»˜ç¯„å›²å†…ã‹ã¤æŒ‡å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®"hours"ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ã‚’åˆè¨ˆã—ã¾ã™
 * ã€åˆå¿ƒè€…å‘ã‘èª¬æ˜ã€‘
 * - Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ä½œæ¥­æ™‚é–“ã‚’è‡ªå‹•ã§é›†è¨ˆã—ã¾ã™
 * - ä¾‹: 2025å¹´10æœˆ1æ—¥ã€œ31æ—¥ã®é–“ã«ç‰¹å®šã®ãƒ¡ãƒ³ãƒãƒ¼ãŒè¨˜éŒ²ã—ãŸä½œæ¥­æ™‚é–“ã‚’ã™ã¹ã¦è¶³ã—ç®—ã—ã¾ã™
 * - è«‹æ±‚æ›¸ã®ä½œæ¥­æ™‚é–“ã‚’æ‰‹å‹•ã§è¨ˆç®—ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™
 *
 * @param {string} startDate - é–‹å§‹æ—¥ï¼ˆYYYY-MM-DDå½¢å¼ã€ä¾‹: "2025-10-01"ï¼‰
 * @param {string} endDate - çµ‚äº†æ—¥ï¼ˆYYYY-MM-DDå½¢å¼ã€ä¾‹: "2025-10-31"ï¼‰
 * @param {string} notionUserId - Notionãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆUUIDå½¢å¼ï¼‰
 * @returns {number} åˆè¨ˆä½œæ¥­æ™‚é–“ï¼ˆæ™‚é–“å˜ä½ï¼‰
 */
function fetchNotionHours(startDate, endDate, notionUserId) {
  console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
  console.log("ğŸ“Š [é–‹å§‹] Notionã‹ã‚‰ä½œæ¥­æ™‚é–“ã‚’å–å¾—ã—ã¾ã™");
  console.log(`ğŸ“… å¯¾è±¡æœŸé–“: ${startDate} ã€œ ${endDate}`);
  console.log(`ğŸ‘¤ å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${notionUserId}`);
  console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

  try {
    // --------------------------------------------------------------------------
    // â–¼ STEP 1: å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¤œè¨¼ â–¼
    // --------------------------------------------------------------------------
    if (!startDate || !endDate) {
      console.error(`âŒ æ—¥ä»˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã§ã™: é–‹å§‹æ—¥="${startDate}", çµ‚äº†æ—¥="${endDate}"`);
      throw new Error(`æ—¥ä»˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…é ˆã§ã™ã€‚å—ä¿¡å€¤: é–‹å§‹æ—¥="${startDate}", çµ‚äº†æ—¥="${endDate}"`);
    }
    if (!notionUserId) {
      console.error(`âŒ Notionãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒç„¡åŠ¹ã§ã™: "${notionUserId}"`);
      throw new Error(`Notionãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå¿…é ˆã§ã™ã€‚å—ä¿¡å€¤: "${notionUserId}"`);
    }
    console.log("âœ… ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¤œè¨¼å®Œäº†");

    // --------------------------------------------------------------------------
    // â–¼ STEP 2: APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æº–å‚™ â–¼
    // --------------------------------------------------------------------------
    // Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æƒ…å ±ã‚’ã€Œå•ã„åˆã‚ã›ï¼ˆã‚¯ã‚¨ãƒªï¼‰ã€ã™ã‚‹ãŸã‚ã®URLã§ã™ã€‚
    const url = `https://api.notion.com/v1/databases/${NOTION_DATABASE_ID}/query`;
    console.log(`æ§‹ç¯‰ã•ã‚ŒãŸURL: ${url}`);

    // Notionã«ã€Œã©ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ãŒæ¬²ã—ã„ã‹ã€ã‚’ä¼ãˆã‚‹ãŸã‚ã®æ¡ä»¶ï¼ˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚
    // ã“ã‚Œã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ç‰¹å®šã®æ¡ä»¶ã«åˆã†ãƒ‡ãƒ¼ã‚¿ã ã‘ã‚’çµã‚Šè¾¼ã‚€ãŸã‚ã«ä½¿ã„ã¾ã™ã€‚
    const payload = {
      // `filter`ï¼šãƒ‡ãƒ¼ã‚¿ã‚’çµã‚Šè¾¼ã‚€ãŸã‚ã®æ¡ä»¶ã‚’æŒ‡å®šã—ã¾ã™ã€‚
      filter: {
        // `and`ï¼šã“ã“ã«åˆ—æŒ™ã•ã‚ŒãŸã™ã¹ã¦ã®æ¡ä»¶ã‚’æº€ãŸã™ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å–å¾—ã—ã¾ã™ã€‚
        and: [
          {
            property: "Start Time", // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã€ŒStart Timeã€ã¨ã„ã†åå‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å¯¾è±¡ã«ã—ã¾ã™ã€‚
            date: {
              on_or_after: startDate, // ãã®æ—¥ä»˜ãŒ `startDate` ä»¥é™ã§ã‚ã‚‹ã“ã¨ã€‚
            },
          },
          {
            property: "End Time", // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã€ŒEnd Timeã€ã¨ã„ã†åå‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å¯¾è±¡ã«ã—ã¾ã™ã€‚
            date: {
              on_or_before: endDate, // ãã®æ—¥ä»˜ãŒ `endDate` ä»¥å‰ã§ã‚ã‚‹ã“ã¨ã€‚
            },
          },
          {
            property: "User", // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã€ŒUserã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆpeopleå‹ï¼‰ã‚’å¯¾è±¡ã«ã—ã¾ã™ã€‚
            people: {
              contains: notionUserId, // æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å«ã‚€ã“ã¨ã€‚
            },
          },
        ],
      },
      // `page_size`ï¼š1å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å–å¾—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ä¸Šé™æ•°ã€‚Notion APIã®æœ€å¤§å€¤ã¯100ã§ã™ã€‚
      page_size: 100,
    };

    console.log("ğŸ“¤ Notionã«é€ä¿¡ã™ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ï¼ˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼‰:", JSON.stringify(payload, null, 2));

    // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿…è¦ãªè¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ã‚’å®šç¾©ã—ã¾ã™ã€‚
    const options = {
      method: "post", // 'post'ã¯ã€Œãƒ‡ãƒ¼ã‚¿ã‚’å•ã„åˆã‚ã›ã‚‹ãƒ»ä½œæˆã™ã‚‹ã€ãªã©ã®æ“ä½œã§ä½¿ã„ã¾ã™ã€‚ä»Šå›ã¯ã‚¯ã‚¨ãƒªãªã®ã§postã§ã™ã€‚
      headers: {
        Authorization: `Bearer ${NOTION_API_KEY}`,
        "Notion-Version": NOTION_API_VERSION,
        "Content-Type": "application/json", // é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒJSONå½¢å¼ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚
      },
      // `payload`ï¼šä¸Šã§ä½œæˆã—ãŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’ã€JSONå½¢å¼ã®æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦è¨­å®šã—ã¾ã™ã€‚
      payload: JSON.stringify(payload),
      muteHttpExceptions: true,
    };
    console.log("ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼:", options.headers);

    // --------------------------------------------------------------------------
    // â–¼ STEP 3: ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç† â–¼
    // --------------------------------------------------------------------------
    let totalHours = 0;
    let hasMore = true; // æ¬¡ã®ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
    let nextCursor = null; // æ¬¡ã®ãƒšãƒ¼ã‚¸ã®é–‹å§‹ä½ç½®ã‚’ç¤ºã™ID
    let pageCount = 0;

    console.log("ğŸ”„ ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆçµæœãŒ100ä»¶ã‚’è¶…ãˆã‚‹å ´åˆã€è¤‡æ•°å›ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚Œã¾ã™ï¼‰");
    // `hasMore`ãŒtrueã§ã‚ã‚‹é™ã‚Šã€ãƒ«ãƒ¼ãƒ—ã‚’ç¶šã‘ã¾ã™ã€‚
    while (hasMore) {
      pageCount++;
      console.log(`\nğŸ“„ ãƒšãƒ¼ã‚¸ ${pageCount} ã®å–å¾—å‡¦ç†ã‚’é–‹å§‹...`);

      // 2ãƒšãƒ¼ã‚¸ç›®ä»¥é™ã®å ´åˆã€`start_cursor`ã‚’ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«è¿½åŠ ã—ã¦ã€å‰å›ã®ç¶šãã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚
      if (nextCursor) {
        console.log(`   ...å‰å›ã®ç¶šãã‹ã‚‰å–å¾—ã—ã¾ã™ (cursor: ${nextCursor})`);
        payload.start_cursor = nextCursor;
        options.payload = JSON.stringify(payload); // ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ›´æ–°
      }

      // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
      console.log(`   ğŸ“¡ Notion APIã«ãƒšãƒ¼ã‚¸ ${pageCount} ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ...`);
      const response = UrlFetchApp.fetch(url, options);
      const responseCode = response.getResponseCode();
      const responseBody = response.getContentText();
      console.log(`   ğŸ“¬ Notion APIã‹ã‚‰ã®å¿œç­”ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${responseCode}`);

      if (responseCode !== 200) {
        console.error(`âŒ Notion APIãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${responseCode}`);
        console.error("--- Notionã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ START ---");
        console.error(responseBody);
        console.error("--- Notionã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ END ---");
        throw new Error(`Notion APIãŒã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã—ã¾ã—ãŸ: ${responseCode}`);
      }

      const data = JSON.parse(responseBody);
      console.log(`   âœ… ãƒšãƒ¼ã‚¸ ${pageCount} ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸï¼ˆ${data.results.length}ä»¶ï¼‰`);

      // --------------------------------------------------------------------------
      // â–¼ STEP 4: å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®å‡¦ç† â–¼
      // --------------------------------------------------------------------------
      if (data.results && data.results.length > 0) {
        // æœ€åˆã®ãƒšãƒ¼ã‚¸ã®æœ€åˆã®ã‚¢ã‚¤ãƒ†ãƒ ã®æ§‹é€ ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
        if (pageCount === 1 && data.results.length > 0) {
          console.log("ğŸ” [ãƒ‡ãƒãƒƒã‚°æƒ…å ±] æœ€åˆã®ãƒšãƒ¼ã‚¸ã®æœ€åˆã®ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ :");
          console.log(JSON.stringify(data.results[0], null, 2));
        }

        let pageHours = 0;

        // å–å¾—ã—ãŸå„ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒšãƒ¼ã‚¸ï¼‰ã«å¯¾ã—ã¦å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
        data.results.forEach((page, index) => {
          const pageId = page.id;
          let hoursValue = 0;
          try {
            // `page.properties.hours` ã«ä½œæ¥­æ™‚é–“ã®ãƒ‡ãƒ¼ã‚¿ãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚
            const hoursProperty = page.properties.hours;
            if (hoursProperty) {
              // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å‹ï¼ˆ'number'ã¾ãŸã¯'formula'ï¼‰ã«å¿œã˜ã¦å€¤ã‚’å–å¾—ã—ã¾ã™ã€‚
              if (hoursProperty.type === "number") {
                hoursValue = hoursProperty.number || 0;
              } else if (hoursProperty.type === "formula") {
                // ãƒ•ã‚©ãƒ¼ãƒŸãƒ¥ãƒ©å‹ã®å ´åˆã€è¨ˆç®—çµæœãŒ `formula.number` ã«å…¥ã£ã¦ã„ã¾ã™ã€‚
                hoursValue = hoursProperty.formula.number || 0;
              }
              // console.log(`     - item ${index + 1} (ID: ${pageId}): ${hoursValue.toFixed(2)} æ™‚é–“`); // å€‹åˆ¥ã®æ™‚é–“ã¯ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã§ç¢ºèªã§ãã‚‹ãŸã‚ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
              pageHours += hoursValue;
            } else {
              console.warn(`     - item ${index + 1} (ID: ${pageId}): 'hours' ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
            }
          } catch (e) {
            console.error(`     - item ${index + 1} (ID: ${pageId}): ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`);
          }
        });

        totalHours += pageHours;
        console.log(`   ğŸ‘‰ ã“ã®ãƒšãƒ¼ã‚¸ã®åˆè¨ˆæ™‚é–“: ${pageHours.toFixed(2)}æ™‚é–“`);
        console.log(`   ç´¯è¨ˆ: ${totalHours.toFixed(2)}æ™‚é–“`);
      }

      // --------------------------------------------------------------------------
      // â–¼ STEP 5: æ¬¡ã®ãƒšãƒ¼ã‚¸ã®æœ‰ç„¡ã‚’ç¢ºèª â–¼
      // --------------------------------------------------------------------------
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« `has_more: true` ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ã¾ã ç¶šãã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚
      hasMore = data.has_more || false;
      // `next_cursor` ã¯ã€æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã©ã“ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚Œã°ã‚ˆã„ã‹ã‚’ç¤ºã™IDã§ã™ã€‚
      nextCursor = data.next_cursor || null;

      if (hasMore) {
        console.log("   ...ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’å–å¾—ã—ã¾ã™ã€‚");
      } else {
        console.log("   ...ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸã€‚");
      }
    }

    console.log("\n" + "â”€".repeat(50));
    console.log(`âœ… [æˆåŠŸ] å…¨ãƒšãƒ¼ã‚¸ã®ä½œæ¥­æ™‚é–“ã®åˆè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚`);
    console.log(`   - å–å¾—ãƒšãƒ¼ã‚¸æ•°: ${pageCount}ãƒšãƒ¼ã‚¸`);
    console.log(`   - åˆè¨ˆä½œæ¥­æ™‚é–“: ${totalHours.toFixed(2)}æ™‚é–“`);
    console.log("â”€".repeat(50) + "\n");
    console.log("âœ… [å®Œäº†] fetchNotionHours() - æˆåŠŸ");
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
    return totalHours;
  } catch (error) {
    console.error(`âŒ Notionã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
    console.error(
      "ğŸ’¡ ãƒ’ãƒ³ãƒˆ: Notion APIã‚­ãƒ¼ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åï¼ˆhours, Start Time, End Timeï¼‰ãŒæ­£ã—ã„ã‹ã€ã¾ãŸã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å…±æœ‰ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    );
    console.error("âŒ [å®Œäº†] fetchNotionHours() - å¤±æ•—");
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
    throw error;
  }
}

// ============================================================================
// ğŸ“ ãƒ¡ã‚¤ãƒ³é–¢æ•°ï¼ˆè«‹æ±‚æ›¸ä½œæˆã®ä¸­å¿ƒå‡¦ç†ï¼‰
// ============================================================================

/**
 * ã€ãƒ¡ã‚¤ãƒ³é–¢æ•°ã€‘è«‹æ±‚æ›¸ã‚’ä¸€æ‹¬ä½œæˆã™ã‚‹é–¢æ•°
 * ã€åˆå¿ƒè€…å‘ã‘èª¬æ˜ã€‘
 * ã“ã®é–¢æ•°ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¸­å¿ƒã§ã™ã€‚ä»¥ä¸‹ã®å‡¦ç†ã‚’è‡ªå‹•ã§è¡Œã„ã¾ã™ï¼š
 * 1. Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰è«‹æ±‚æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
 * 2. Notionã‹ã‚‰ä½œæ¥­æ™‚é–“ã‚’å–å¾—
 * 3. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æƒ…å ±ã‚’åŸ‹ã‚è¾¼ã¿
 * 4. PDFã‚’ä½œæˆã—ã¦Google Driveã«ä¿å­˜
 * 5. è«‹æ±‚æ›¸ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡
 *
 * ã€ä½¿ã„æ–¹ã€‘
 * Google Apps Scriptã®ã‚¨ãƒ‡ã‚£ã‚¿ã§ã€ŒcreateInvoicesã€é–¢æ•°ã‚’é¸æŠã—ã¦å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã ã‘ï¼
 */
function createInvoices() {
  console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  console.log("â•‘                    è«‹æ±‚æ›¸è‡ªå‹•ä½œæˆã‚’é–‹å§‹ã—ã¾ã™                    â•‘");
  console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  console.log("ğŸ“‚ [ã‚¹ãƒ†ãƒƒãƒ—1] ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ã¦ã„ã¾ã™...");

  // ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
  const dataSpreadsheet = SpreadsheetApp.openById(DATA_SPREADSHEET_ID);
  const dataSheet = dataSpreadsheet.getSheetByName(DATA_SHEET_NAME);

  // ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†
  if (!dataSheet) {
    console.error(`âŒ ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ "${DATA_SHEET_NAME}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
    console.error("ğŸ’¡ ãƒ’ãƒ³ãƒˆ: DATA_SHEET_NAMEã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„");
    return;
  }
  console.log(`âœ… ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã‚’é–‹ãã¾ã—ãŸ: "${DATA_SHEET_NAME}"`);

  // è«‹æ±‚æ›¸ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
  const templateSpreadsheet = SpreadsheetApp.openById(TEMPLATE_SPREADSHEET_ID);
  const templateSheet = templateSpreadsheet.getSheetByName(TEMPLATE_SHEET_NAME);

  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†
  if (!templateSheet) {
    console.error(`âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ãƒ¼ãƒˆ "${TEMPLATE_SHEET_NAME}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
    console.error("ğŸ’¡ ãƒ’ãƒ³ãƒˆ: TEMPLATE_SHEET_NAMEã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„");
    return;
  }
  console.log(`âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ãƒ¼ãƒˆã‚’é–‹ãã¾ã—ãŸ: "${TEMPLATE_SHEET_NAME}"\n`);

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  console.log("ğŸ“Š [ã‚¹ãƒ†ãƒƒãƒ—2] ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...");

  // ã‚·ãƒ¼ãƒˆå…¨ä½“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆ2æ¬¡å…ƒé…åˆ—ã¨ã—ã¦å–å¾—ã•ã‚Œã‚‹ï¼‰
  const data = dataSheet.getDataRange().getValues();

  // 1è¡Œç›®ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆåˆ—åï¼‰
  const headers = data[0];
  console.log(`ğŸ“‹ ãƒ˜ãƒƒãƒ€ãƒ¼: ${headers.join(", ")}`);

  // 2è¡Œç›®ä»¥é™ãŒå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿
  const dataRows = data.slice(1);

  // å„è¡Œã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚­ãƒ¼ã«ã™ã‚‹ï¼‰
  // ä¾‹: { seller_name: "æ ªå¼ä¼šç¤¾ABC", seller_email: "abc@example.com", ... }
  const invoiceDataRows = dataRows.map((row) => {
    const invoice = {};
    headers.forEach((header, index) => {
      invoice[header] = row[index];
    });
    return invoice;
  });

  console.log(`âœ… ${invoiceDataRows.length}ä»¶ã®è«‹æ±‚æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ\n`);

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // ã‚¹ãƒ†ãƒƒãƒ—3: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¤‰æ•°ã‚’åˆæœŸåŒ–ï¼ˆå‡¦ç†çµæœã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ï¼‰
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  let successCount = 0; // PDFä½œæˆæˆåŠŸæ•°
  let failureCount = 0; // PDFä½œæˆå¤±æ•—æ•°
  let skippedCount = 0; // ã‚¹ã‚­ãƒƒãƒ—æ•°
  let emailsSentCount = 0; // ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸæ•°
  let emailsFailedCount = 0; // ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ•°

  console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  console.log(`â•‘              ${invoiceDataRows.length}ä»¶ã®è«‹æ±‚æ›¸ä½œæˆã‚’é–‹å§‹ã—ã¾ã™                      â•‘`);
  console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // ã‚¹ãƒ†ãƒƒãƒ—4: è«‹æ±‚æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’1è¡Œãšã¤å‡¦ç†
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  invoiceDataRows.forEach((invoice, index) => {
    console.log("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    console.log(`â”‚  è«‹æ±‚æ›¸ ${index + 1}/${invoiceDataRows.length} ã®ä½œæˆã‚’é–‹å§‹                                    â”‚`);
    console.log(`â”‚  å®›å…ˆ: ${invoice.seller_name}                                  `);
    console.log("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ã‚¹ãƒ†ãƒƒãƒ—4-0: invoice_neededãƒ•ãƒ©ã‚°ã®ãƒã‚§ãƒƒã‚¯
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    console.log("  ğŸ” è«‹æ±‚æ›¸ç”Ÿæˆãƒ•ãƒ©ã‚°ã‚’ç¢ºèªä¸­...");

    // invoice_neededãŒæ˜ç¤ºçš„ã«TRUEã§ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    const invoiceNeeded = String(invoice.invoice_needed).toUpperCase();
    if (invoiceNeeded !== "TRUE") {
      skippedCount++;
      console.log(`  âŠ˜ è«‹æ±‚æ›¸ ${index + 1}: invoice_needed=${invoice.invoice_needed} ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™`);
      console.log(`  â„¹ï¸ ${invoice.seller_name} ã®è«‹æ±‚æ›¸ç”Ÿæˆã¯ä¸è¦ã¨è¨­å®šã•ã‚Œã¦ã„ã¾ã™\n`);
      return;
    }

    console.log(`  âœ… invoice_needed=TRUE - è«‹æ±‚æ›¸ç”Ÿæˆã‚’ç¶šè¡Œã—ã¾ã™`);

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ã‚¹ãƒ†ãƒƒãƒ—4-1: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½œæ¥­ç”¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    console.log("  ğŸ“„ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½œæ¥­ç”¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆä¸­...");
    const copiedSheet = templateSheet.copyTo(templateSpreadsheet);
    const newSheetName = `temp_${index + 1}`; // ä¸€æ™‚çš„ãªã‚·ãƒ¼ãƒˆå
    copiedSheet.setName(newSheetName);
    console.log(`  âœ… ä½œæ¥­ç”¨ã‚·ãƒ¼ãƒˆä½œæˆå®Œäº†: "${newSheetName}"`);

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ã‚¹ãƒ†ãƒƒãƒ—4-2: ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—ã—ã¦PDFãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    console.log("  ğŸ“… æ—¥ä»˜æƒ…å ±ã‚’ç”Ÿæˆä¸­...");
    const currentDate = new Date();
    const formattedDate = Utilities.formatDate(currentDate, "JST", "yyyy/MM/dd");
    const pdfFileName = Utilities.formatDate(currentDate, "JST", "yyyyMMdd") + "_æ ªå¼ä¼šç¤¾DROXæ§˜_è«‹æ±‚æ›¸";
    console.log(`  âœ… è«‹æ±‚æ—¥: ${formattedDate}`);
    console.log(`  âœ… PDFãƒ•ã‚¡ã‚¤ãƒ«å: ${pdfFileName}.pdf`);

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ã‚¹ãƒ†ãƒƒãƒ—4-3: Notionã‹ã‚‰ä½œæ¥­æ™‚é–“ã‚’å–å¾—ï¼ˆé‡è¦ï¼ï¼‰
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    console.log("  â° Notionã‹ã‚‰ä½œæ¥­æ™‚é–“ã‚’å–å¾—ä¸­...");
    let itemNumber = 0; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯0æ™‚é–“

    // notion_user_idã®æ¤œè¨¼
    if (!invoice.notion_user_id || invoice.notion_user_id.trim() === "") {
      console.warn(`  âš ï¸ notion_user_idãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Notionã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™`);
      console.log(`  â„¹ï¸ ä½œæ¥­æ™‚é–“: 0æ™‚é–“ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰`);
    } else {
      try {
        // TODO: å°†æ¥çš„ã«ã¯å‹•çš„ã«æ—¥ä»˜ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        // ç¾åœ¨ã¯å›ºå®šå€¤ã‚’ä½¿ç”¨
        const startDate = "2025-10-01";
        const endDate = "2025-10-31";

        console.log(`  ğŸ“Š å¯¾è±¡æœŸé–“: ${startDate} ã€œ ${endDate}`);
        console.log(`  ğŸ‘¤ å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${invoice.seller_name} (ID: ${invoice.notion_user_id})`);

        const notionHours = fetchNotionHours(startDate, endDate, invoice.notion_user_id);

        if (notionHours !== null && notionHours !== undefined) {
          itemNumber = notionHours;
          console.log(`  âœ… Notionã‹ã‚‰å–å¾—ã—ãŸä½œæ¥­æ™‚é–“ã‚’ä½¿ç”¨: ${notionHours}æ™‚é–“`);
        } else {
          console.log(`  âš ï¸ Notionã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä½œæ¥­æ™‚é–“: 0æ™‚é–“`);
        }
      } catch (notionError) {
        console.error(`  âŒ Notionãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½œæ¥­æ™‚é–“: 0æ™‚é–“`);
        console.error(`  ã‚¨ãƒ©ãƒ¼è©³ç´°: ${notionError.message}`);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚0æ™‚é–“ã§ç¶šè¡Œ
      }
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ã‚¹ãƒ†ãƒƒãƒ—4-4: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆ
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    console.log("  ğŸ”„ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã¿ä¸­...");

    // è«‹æ±‚æ—¥ã‚’ç½®ãæ›ãˆ
    copiedSheet.createTextFinder("{{invoice_date}}").replaceAllWith(formattedDate);
    console.log("    âœ“ è«‹æ±‚æ—¥");

    // è«‹æ±‚å…ˆæƒ…å ±ã‚’ç½®ãæ›ãˆ
    copiedSheet.createTextFinder("{{seller_name}}").replaceAllWith(invoice.seller_name);
    copiedSheet.createTextFinder("{{seller_address}}").replaceAllWith(invoice.seller_address);
    console.log("    âœ“ è«‹æ±‚å…ˆæƒ…å ±");

    // é …ç›®è©³ç´°ã‚’ç½®ãæ›ãˆï¼ˆNotionã¾ãŸã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—ã—ãŸä½œæ¥­æ™‚é–“ã‚’ä½¿ç”¨ï¼‰
    copiedSheet.createTextFinder("{{item_1_name}}").replaceAllWith(invoice.item_1_name);
    copiedSheet.createTextFinder("{{item_1_number}}").replaceAllWith(itemNumber);
    copiedSheet.createTextFinder("{{item_1_price}}").replaceAllWith(invoice.item_1_price);
    console.log("    âœ“ é …ç›®è©³ç´°");

    // éŠ€è¡Œæƒ…å ±ã‚’ç½®ãæ›ãˆ
    copiedSheet.createTextFinder("{{seller_bank_name}}").replaceAllWith(invoice.seller_bank_name);
    copiedSheet.createTextFinder("{{seller_bank_type}}").replaceAllWith(invoice.seller_bank_type);
    copiedSheet.createTextFinder("{{seller_bank_number}}").replaceAllWith(invoice.seller_bank_number);
    copiedSheet.createTextFinder("{{seller_bank_holder_name}}").replaceAllWith(invoice.seller_bank_holder_name);
    console.log("    âœ“ éŠ€è¡Œæƒ…å ±");

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ã‚¹ãƒ†ãƒƒãƒ—4-5: å¤‰æ›´ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å³åº§ã«åæ˜ 
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    SpreadsheetApp.flush(); // ãƒãƒƒãƒ•ã‚¡ã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã—ã¦ç¢ºå®Ÿã«ä¿å­˜
    console.log("  âœ… ãƒ‡ãƒ¼ã‚¿ã®åŸ‹ã‚è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ");

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ã‚¹ãƒ†ãƒƒãƒ—4-6: å‡ºåŠ›å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¤œè¨¼ï¼ˆå¿…é ˆé …ç›®ï¼‰
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    console.log("  ğŸ“ å‡ºåŠ›å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªä¸­...");

    if (!invoice.output_folder_id || invoice.output_folder_id.trim() === "") {
      failureCount++;
      console.error(`  âŒ è«‹æ±‚æ›¸ ${index + 1}: output_folder_idï¼ˆå‡ºåŠ›å…ˆãƒ•ã‚©ãƒ«ãƒ€IDï¼‰ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“`);
      console.error("  ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®output_folder_idåˆ—ã«Google Driveã®ãƒ•ã‚©ãƒ«ãƒ€IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      templateSpreadsheet.deleteSheet(copiedSheet);
      return;
    }

    let targetFolder;
    try {
      targetFolder = DriveApp.getFolderById(invoice.output_folder_id);
      console.log(`  âœ… å‡ºåŠ›å…ˆãƒ•ã‚©ãƒ«ãƒ€ID: ${invoice.output_folder_id}`);
    } catch (e) {
      failureCount++;
      console.error(`  âŒ è«‹æ±‚æ›¸ ${index + 1}: ç„¡åŠ¹ãªoutput_folder_id: ${invoice.output_folder_id}`);
      console.error(`  ã‚¨ãƒ©ãƒ¼è©³ç´°: ${e.message}`);
      console.error("  ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ãƒ•ã‚©ãƒ«ãƒ€IDãŒæ­£ã—ã„ã‹ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„");
      templateSpreadsheet.deleteSheet(copiedSheet);
      return;
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ã‚¹ãƒ†ãƒƒãƒ—4-7: PDFã‚’ä½œæˆã—ã¦Google Driveã«ä¿å­˜
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    console.log("  ğŸ“„ PDFã‚’ä½œæˆä¸­...");

    let pdfFile = null;
    try {
      pdfFile = createPdfInDrive(templateSpreadsheet, copiedSheet.getSheetId(), targetFolder, pdfFileName);
      successCount++;
      console.log(`  âœ… è«‹æ±‚æ›¸ ${index + 1}: PDFä½œæˆæˆåŠŸ - ${pdfFileName}.pdf`);
    } catch (e) {
      failureCount++;
      console.error(`  âŒ è«‹æ±‚æ›¸ ${index + 1}: PDFä½œæˆå¤±æ•— - ${pdfFileName}.pdf`);
      console.error(`  ã‚¨ãƒ©ãƒ¼è©³ç´°: ${e.message}`);
      templateSpreadsheet.deleteSheet(copiedSheet);
      return;
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ã‚¹ãƒ†ãƒƒãƒ—4-8: ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    if (EMAIL_ENABLED && pdfFile) {
      console.log("  ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ã‚’é–‹å§‹...");

      const recipientEmail = invoice.seller_email;
      const recipientName = invoice.seller_name;

      if (recipientEmail && recipientEmail.includes("@")) {
        const emailSent = sendInvoiceEmail(recipientEmail, recipientName, pdfFile, formattedDate);

        if (emailSent) {
          emailsSentCount++;
          console.log(`  âœ… è«‹æ±‚æ›¸ ${index + 1}: ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ â†’ ${recipientEmail}`);
        } else {
          emailsFailedCount++;
          console.error(`  âŒ è«‹æ±‚æ›¸ ${index + 1}: ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•— â†’ ${recipientEmail}`);
        }
      } else {
        console.warn(`  âš ï¸ è«‹æ±‚æ›¸ ${index + 1}: æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãªã„ãŸã‚ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™`);
      }
    } else if (!EMAIL_ENABLED) {
      console.log("  â„¹ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ï¼ˆEMAIL_ENABLED = falseï¼‰");
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ã‚¹ãƒ†ãƒƒãƒ—4-9: ä½œæ¥­ç”¨ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    templateSpreadsheet.deleteSheet(copiedSheet);
    console.log(`  ğŸ—‘ï¸ ä½œæ¥­ç”¨ã‚·ãƒ¼ãƒˆ "${newSheetName}" ã‚’å‰Šé™¤ã—ã¾ã—ãŸ\n`);
  });

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // å‡¦ç†å®Œäº†ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  console.log("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  console.log("â•‘                    ğŸ“Š å‡¦ç†çµæœã‚µãƒãƒªãƒ¼                          â•‘");
  console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log(`\nğŸ“ å‡¦ç†ã—ãŸè«‹æ±‚æ›¸ã®ç·æ•°: ${invoiceDataRows.length}ä»¶`);
  console.log(`\nã€PDFä½œæˆçµæœã€‘`);
  console.log(`  âœ… æˆåŠŸ: ${successCount}ä»¶`);
  console.log(`  âŒ å¤±æ•—: ${failureCount}ä»¶`);
  console.log(`  âŠ˜ ã‚¹ã‚­ãƒƒãƒ—: ${skippedCount}ä»¶`);

  if (EMAIL_ENABLED) {
    console.log(`\nã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡çµæœã€‘`);
    console.log(`  âœ… é€ä¿¡æˆåŠŸ: ${emailsSentCount}ä»¶`);
    console.log(`  âŒ é€ä¿¡å¤±æ•—: ${emailsFailedCount}ä»¶`);

    if (TEST_MODE) {
      console.log("\nâš ï¸ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã§ã—ãŸ - å®Ÿéš›ã«ã¯ãƒ¡ãƒ¼ãƒ«ã¯é€ä¿¡ã•ã‚Œã¦ã„ã¾ã›ã‚“");
      console.log("   æœ¬ç•ªç’°å¢ƒã§ä½¿ç”¨ã™ã‚‹å ´åˆã¯ TEST_MODE ã‚’ false ã«è¨­å®šã—ã¦ãã ã•ã„");
    }
  } else {
    console.log("\nğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡: ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ï¼ˆEMAIL_ENABLED = falseï¼‰");
  }

  console.log("\n" + "=".repeat(64));
  console.log("ğŸ‰ ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
  console.log("=".repeat(64) + "\n");
}

// ============================================================================
// ğŸ“„ PDFä½œæˆé–¢æ•°
// ============================================================================

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æŒ‡å®šã‚·ãƒ¼ãƒˆã‚’PDFã¨ã—ã¦Google Driveã«ä¿å­˜ã™ã‚‹é–¢æ•°
 * ã€åˆå¿ƒè€…å‘ã‘èª¬æ˜ã€‘
 * - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚·ãƒ¼ãƒˆã‚’PDFãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›ã—ã¾ã™
 * - Google Driveã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆAPIã‚’ä½¿ç”¨ã—ã¦é«˜å“è³ªãªPDFã‚’ç”Ÿæˆã—ã¾ã™
 * - ç”¨ç´™ã‚µã‚¤ã‚ºã€ä½™ç™½ã€é…ç½®ãªã©ã‚’ç´°ã‹ãè¨­å®šã§ãã¾ã™
 *
 * @param {Spreadsheet} spreadsheet - PDFåŒ–ã™ã‚‹ã‚·ãƒ¼ãƒˆãŒå«ã¾ã‚Œã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ
 * @param {string} sheetId - PDFåŒ–ã™ã‚‹ã‚·ãƒ¼ãƒˆã®ID
 * @param {Folder} folder - PDFã‚’ä¿å­˜ã™ã‚‹Google Driveãƒ•ã‚©ãƒ«ãƒ€
 * @param {string} fileName - PDFã®ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ‹¡å¼µå­ãªã—ï¼‰
 * @returns {File} ä½œæˆã•ã‚ŒãŸPDFãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function createPdfInDrive(spreadsheet, sheetId, folder, fileName) {
  console.log("    ğŸ“„ [é–‹å§‹] PDFã‚’ä½œæˆã—ã¦Google Driveã«ä¿å­˜ã—ã¾ã™");

  try {
    // --------------------------------------------------------------------------
    // â–¼ STEP 1: PDFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã®URLã‚’æ§‹ç¯‰ â–¼
    // --------------------------------------------------------------------------
    // Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’PDFã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã®ç‰¹åˆ¥ãªURLã‚’çµ„ã¿ç«‹ã¦ã¾ã™ã€‚
    // ã“ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€æŒ‡å®šã—ãŸå½¢å¼ã§PDFãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
    const spreadsheetId = spreadsheet.getId();
    const exportUrl =
      `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?` +
      "format=pdf" +              // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: PDF
      "&gid=" + sheetId +         // å¯¾è±¡ã‚·ãƒ¼ãƒˆã®ID
      "&size=A4" +                // ç”¨ç´™ã‚µã‚¤ã‚º: A4
      "&portrait=true" +          // å‘ã: ç¸¦
      "&scale=3" +                // ã‚¹ã‚±ãƒ¼ãƒ«: é«˜ã•ã«åˆã‚ã›ã‚‹ (æ¨å¥¨)
      "&top_margin=0.2" +         // ä¸Šä½™ç™½ (ã‚¤ãƒ³ãƒ)
      "&bottom_margin=0.2" +      // ä¸‹ä½™ç™½ (ã‚¤ãƒ³ãƒ)
      "&left_margin=0.2" +        // å·¦ä½™ç™½ (ã‚¤ãƒ³ãƒ)
      "&right_margin=0.2" +       // å³ä½™ç™½ (ã‚¤ãƒ³ãƒ)
      "&sheetnames=false" +       // ã‚·ãƒ¼ãƒˆåã‚’éè¡¨ç¤º
      "&printtitle=false" +       // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåã‚’éè¡¨ç¤º
      "&gridlines=false" +        // ã‚°ãƒªãƒƒãƒ‰ç·šã‚’éè¡¨ç¤º
      "&fzr=false" +              // å›ºå®šè¡Œã‚’ç„¡è¦–
      "&horizontal_alignment=CENTER" + // æ°´å¹³é…ç½®: ä¸­å¤®
      "&vertical_alignment=TOP";     // å‚ç›´é…ç½®: ä¸Š

    console.log(`      - PDFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆURLã‚’æ§‹ç¯‰ã—ã¾ã—ãŸã€‚`);
    // console.log(`      URL: ${exportUrl}`); // ãƒ‡ãƒãƒƒã‚°æ™‚ã«URLã‚’ç¢ºèªã—ãŸã„å ´åˆã¯ã“ã®è¡Œã‚’æœ‰åŠ¹åŒ–

    // --------------------------------------------------------------------------
    // â–¼ STEP 2: APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æº–å‚™ â–¼
    // --------------------------------------------------------------------------
    // Googleã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ã€Œèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã€ã‚’å–å¾—ã—ã¾ã™ã€‚
    // ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä»£ã‚ã‚Šã«Google Driveã‚„Spreadsheetã‚’æ“ä½œã™ã‚‹è¨±å¯ã‚’å¾—ã¾ã™ã€‚
    const token = ScriptApp.getOAuthToken();

    // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿…è¦ãªè¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ã‚’å®šç¾©ã—ã¾ã™ã€‚
    const options = {
      headers: {
        // Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ã«èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã—ã¾ã™ã€‚
        Authorization: "Bearer " + token,
      },
      muteHttpExceptions: true, // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’åœæ­¢ã•ã›ãªã„
    };
    console.log("      - APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã—ã¾ã—ãŸã€‚");

    // --------------------------------------------------------------------------
    // â–¼ STEP 3: PDFãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨ä¿å­˜ â–¼
    // --------------------------------------------------------------------------
    console.log("      - ğŸ“¥ PDFãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™...");
    // UrlFetchApp.fetch() ã‚’ä½¿ã£ã¦ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆURLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€PDFãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚
    const response = UrlFetchApp.fetch(exportUrl, options);
    const responseCode = response.getResponseCode();

    if (responseCode === 200) {
      console.log(`      - âœ… PDFãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«æˆåŠŸã—ã¾ã—ãŸ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${responseCode})`);
      // å–å¾—ã—ãŸPDFãƒ‡ãƒ¼ã‚¿ã‚’ã€ŒBlobã€ã¨ã„ã†ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿å½¢å¼ã«å¤‰æ›ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®šã—ã¾ã™ã€‚
      const blob = response.getBlob().setName(fileName + ".pdf");

      console.log(`      - ğŸ’¾ PDFã‚’Google Driveãƒ•ã‚©ãƒ«ãƒ€ã€Œ${folder.getName()}ã€ã«ä¿å­˜ã—ã¦ã„ã¾ã™...`);
      // æŒ‡å®šã•ã‚ŒãŸGoogle Driveãƒ•ã‚©ãƒ«ãƒ€ã«PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
      const pdfFile = folder.createFile(blob);
      console.log(`      - âœ… PDFã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸ: ${pdfFile.getName()}`);

      // ä½œæˆã—ãŸPDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿”ã™
      return pdfFile;
    } else {
      // ã‚¨ãƒ©ãƒ¼å‡¦ç†
      const errorResponse = response.getContentText();
      console.error(`      - âŒ PDFã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${responseCode})`);
      console.error(`      - ã‚¨ãƒ©ãƒ¼å†…å®¹: ${errorResponse}`);
      throw new Error(`PDFã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${responseCode}`);
    }
  } catch (error) {
    console.error(`    âŒ PDFä½œæˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
    // ã‚¨ãƒ©ãƒ¼ã‚’å‘¼ã³å‡ºã—å…ƒã«å†ã‚¹ãƒ­ãƒ¼ã—ã¦ã€ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†ã§æ•æ‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
    throw error;
  }
}

// ============================================================================
// ãƒ¡ãƒ¼ãƒ«é€ä¿¡é–¢æ•°
// ============================================================================

/**
 * è«‹æ±‚æ›¸PDFã®ãƒªãƒ³ã‚¯ã‚’å«ã‚€ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
 * ã€åˆå¿ƒè€…å‘ã‘èª¬æ˜ã€‘
 * - ä½œæˆã—ãŸè«‹æ±‚æ›¸PDFã¸ã®ãƒªãƒ³ã‚¯ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ã—ã¾ã™
 * - æ—¥æœ¬èªã®ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«å½¢å¼ã§ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™
 * - TEST_MODE ã‚’ true ã«ã™ã‚‹ã¨å®Ÿéš›ã«ã¯é€ä¿¡ã›ãšãƒ­ã‚°ã ã‘å‡ºåŠ›ã•ã‚Œã¾ã™ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
 *
 * @param {string} recipientEmail - å—ä¿¡è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @param {string} recipientName - å—ä¿¡è€…ã®åå‰
 * @param {File} pdfFile - Google Driveã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @param {string} invoiceDate - è«‹æ±‚æ—¥ï¼ˆYYYY/MM/DDå½¢å¼ï¼‰
 * @returns {boolean} ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸæ™‚ã¯ trueã€å¤±æ•—æ™‚ã¯ false
 */
function sendInvoiceEmail(recipientEmail, recipientName, pdfFile, invoiceDate) {
  console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
  console.log("ğŸ“§ [é–‹å§‹] ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†");
  console.log(`ğŸ“¬ å®›å…ˆ: ${recipientName} <${recipientEmail}>`);
  console.log(`ğŸ“… è«‹æ±‚æ—¥: ${invoiceDate}`);
  console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

  try {
    // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ¤œè¨¼
    // @ãƒãƒ¼ã‚¯ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
    if (!recipientEmail || !recipientEmail.includes("@")) {
      console.error(`âŒ ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™: ${recipientEmail}`);
      console.error("âŒ [å®Œäº†] sendInvoiceEmail() - å¤±æ•—ï¼ˆç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰");
      console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
      return false;
    }
    console.log("âœ“ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ¤œè¨¼å®Œäº†");

    // ã‚¹ãƒ†ãƒƒãƒ—2: PDFãƒ•ã‚¡ã‚¤ãƒ«ã®å…±æœ‰URLã‚’å–å¾—
    console.log("ğŸ”— PDFå…±æœ‰URLã‚’ç”Ÿæˆä¸­...");
    const pdfUrl = getPdfShareableUrl(pdfFile);

    // ã‚¹ãƒ†ãƒƒãƒ—3: è«‹æ±‚æ—¥ã‹ã‚‰å¹´ã¨æœˆã‚’æŠ½å‡º
    // getMonth()ã¯0-11ã‚’è¿”ã™ã®ã§+1ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
    const dateObj = new Date(invoiceDate);
    const year = dateObj.getFullYear();
    const month = dateObj.getMonth() + 1;
    console.log(`âœ“ å¯¾è±¡æœŸé–“: ${year}å¹´${month}æœˆ`);

    // ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ¡ãƒ¼ãƒ«ã®ä»¶åã‚’ä½œæˆ
    const subject = `è«‹æ±‚æ›¸é€ä»˜ã®ã”æ¡ˆå†… [${year}å¹´${month}æœˆåˆ†]`;
    console.log(`âœ“ ä»¶å: ${subject}`);

    // ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ä½œæˆï¼ˆHTMLå½¢å¼ï¼‰
    console.log("âœï¸ ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ä½œæˆä¸­...");
    const body = createEmailBody(recipientName, year, month, pdfUrl);

    // ã‚¹ãƒ†ãƒƒãƒ—6: ãƒ¡ãƒ¼ãƒ«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
    const options = {
      name: SENDER_NAME, // é€ä¿¡è€…å
      htmlBody: body, // HTMLå½¢å¼ã®æœ¬æ–‡
      from: SENDER_EMAIL, // é€ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    };

    // ã‚¹ãƒ†ãƒƒãƒ—7: ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ï¼ˆã¾ãŸã¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ­ã‚°å‡ºåŠ›ã®ã¿ï¼‰
    if (TEST_MODE) {
      // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: å®Ÿéš›ã«ã¯é€ä¿¡ã›ãšã€ãƒ­ã‚°ã ã‘å‡ºåŠ›
      console.log("âš ï¸ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ãƒ¡ãƒ¼ãƒ«ã¯å®Ÿéš›ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“");
      console.log(`   å®›å…ˆ: ${recipientEmail}`);
      console.log(`   ä»¶å: ${subject}`);
      console.log(`   PDF URL: ${pdfUrl}`);
      console.log("âœ… [å®Œäº†] sendInvoiceEmail() - æˆåŠŸï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰");
      console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
      return true;
    } else {
      // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰: å®Ÿéš›ã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
      console.log("ğŸ“¤ ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ä¸­...");
      GmailApp.sendEmail(recipientEmail, subject, body, options);
      console.log(`âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ: ${recipientEmail}`);
      console.log("âœ… [å®Œäº†] sendInvoiceEmail() - æˆåŠŸ");
      console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
      return true;
    }
  } catch (error) {
    console.error(`âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${recipientEmail}`);
    console.error(`ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}`);
    console.error("ğŸ’¡ ãƒ’ãƒ³ãƒˆ: Gmail APIã®æ¨©é™ã€é€ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€å—ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
    console.error("âŒ [å®Œäº†] sendInvoiceEmail() - å¤±æ•—");
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
    return false;
  }
}

/**
 * Google Driveã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã®å…±æœ‰URLã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
 * ã€åˆå¿ƒè€…å‘ã‘èª¬æ˜ã€‘
 * - PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ãŒé–²è¦§å¯èƒ½ã€ã«è¨­å®šã—ã¾ã™
 * - ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ã§ãã‚‹å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã—ã¾ã™
 * - å—ä¿¡è€…ã¯ã“ã®ãƒªãƒ³ã‚¯ã‹ã‚‰PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™
 *
 * @param {File} pdfFile - PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string} PDFå…±æœ‰URL
 */
function getPdfShareableUrl(pdfFile) {
  console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
  console.log("ğŸ”— [é–‹å§‹] PDFå…±æœ‰URLç”Ÿæˆ");
  console.log(`ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«å: ${pdfFile.getName()}`);
  console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

  try {
    // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ•ã‚¡ã‚¤ãƒ«ã®å…±æœ‰è¨­å®šã‚’å¤‰æ›´
    // ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ã€ãŒã€Œé–²è¦§ã€ã§ãã‚‹ã‚ˆã†ã«è¨­å®š
    console.log("ğŸ”“ å…±æœ‰è¨­å®šã‚’å¤‰æ›´ä¸­...");
    pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    console.log("âœ… å…±æœ‰è¨­å®šå®Œäº†: ãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ãŒé–²è¦§å¯èƒ½");

    // ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’å–å¾—ã—ã¦å…±æœ‰URLã‚’ç”Ÿæˆ
    const fileId = pdfFile.getId();
    const shareableUrl = `https://drive.google.com/file/d/${fileId}/view?usp=sharing`;

    console.log(`âœ… å…±æœ‰URLç”Ÿæˆå®Œäº†`);
    console.log(`   URL: ${shareableUrl}`);
    console.log("âœ… [å®Œäº†] getPdfShareableUrl() - æˆåŠŸ");
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
    return shareableUrl;
  } catch (error) {
    console.error(`âŒ å…±æœ‰URLã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
    console.error("ğŸ’¡ ãƒ’ãƒ³ãƒˆ: Google Driveã®æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
    console.error("âŒ [å®Œäº†] getPdfShareableUrl() - å¤±æ•—");
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
    throw error;
  }
}

/**
 * æ—¥æœ¬èªãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«å½¢å¼ã®ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ä½œæˆã™ã‚‹é–¢æ•°
 * ã€åˆå¿ƒè€…å‘ã‘èª¬æ˜ã€‘
 * - HTMLå½¢å¼ã§è¦‹æ „ãˆã®è‰¯ã„ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ä½œæˆã—ã¾ã™
 * - æ—¥æœ¬èªã®ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«å®šå‹æ–‡ã‚’ä½¿ç”¨ã—ã¾ã™
 * - PDFé–²è¦§ç”¨ã®ãƒœã‚¿ãƒ³ã¨ãƒªãƒ³ã‚¯ã‚’å«ã‚ã¾ã™
 *
 * @param {string} recipientName - å—ä¿¡è€…ã®åå‰ï¼ˆã€Œã€œæ§˜ã€ã‚’ä»˜ã‘ã¦è¡¨ç¤ºï¼‰
 * @param {number} year - è«‹æ±‚å¹´
 * @param {number} month - è«‹æ±‚æœˆ
 * @param {string} pdfUrl - PDFãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®URL
 * @returns {string} HTMLå½¢å¼ã®ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡
 */
function createEmailBody(recipientName, year, month, pdfUrl) {
  console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
  console.log("âœ‰ï¸ [é–‹å§‹] ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ä½œæˆ");
  console.log(`ğŸ“ å®›å…ˆ: ${recipientName}`);
  console.log(`ğŸ“… å¯¾è±¡æœŸé–“: ${year}å¹´${month}æœˆ`);
  console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

  // HTMLå½¢å¼ã®ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ä½œæˆ
  // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å«ã‚ã‚‹ã“ã¨ã§ã€ãƒ¡ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§è¦‹æ „ãˆè‰¯ãè¡¨ç¤ºã•ã‚Œã¾ã™
  const htmlBody = `
    <div style="font-family: 'Hiragino Sans', 'Meiryo', sans-serif; line-height: 1.6; color: #333;">
      <!-- å®›å -->
      <p>${recipientName} æ§˜</p>

      <!-- æŒ¨æ‹¶æ–‡ -->
      <p>ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚<br>
      æ ªå¼ä¼šç¤¾DROXã§ã™ã€‚</p>

      <!-- æœ¬æ–‡ -->
      <p>${year}å¹´${month}æœˆåˆ†ã®è«‹æ±‚æ›¸ã‚’ãŠé€ã‚Šã„ãŸã—ã¾ã™ã€‚<br>
      ä¸‹è¨˜ãƒªãƒ³ã‚¯ã‚ˆã‚Šã”ç¢ºèªãã ã•ã„ã€‚</p>

      <!-- PDFãƒªãƒ³ã‚¯ï¼ˆãƒœã‚¿ãƒ³å½¢å¼ï¼‰ -->
      <p style="margin: 20px 0;">
        <a href="${pdfUrl}" style="background-color: #2563EB; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: 500;">
          è«‹æ±‚æ›¸ã‚’ç¢ºèªã™ã‚‹
        </a>
      </p>

      <!-- ç¢ºèªä¾é ¼ï¼ˆç›®ç«‹ã¤å½¢å¼ï¼‰ -->
      <div style="background-color: #EFF6FF; border: 2px solid #3B82F6; border-radius: 8px; padding: 20px; margin: 30px 0; text-align: center;">
        <p style="font-size: 14px; color: #1E40AF; margin: 0;">
          å•é¡Œãªã‘ã‚Œã°ã€<strong style="font-size: 18px; color: #1D4ED8;">ã€ŒOK DROX!ã€</strong>ã¨è¿”ä¿¡ãŠé¡˜ã„ã—ã¾ã™ã€‚
        </p>
      </div>

      <!-- ç· ã‚ã®æŒ¨æ‹¶ -->
      <p style="margin-top: 30px;">
      ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚<br>
      ä»Šå¾Œã¨ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</p>

      <!-- åŒºåˆ‡ã‚Šç·š -->
      <hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">

      <!-- ç½²å -->
      <p style="font-size: 12px; color: #666;">
      æ ªå¼ä¼šç¤¾DROX<br>
      ${SENDER_EMAIL}<br>
      </p>
    </div>
  `;

  console.log("âœ… ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ä½œæˆå®Œäº†");
  console.log(`   æœ¬æ–‡ã®é•·ã•: ${htmlBody.length}æ–‡å­—`);
  console.log("âœ… [å®Œäº†] createEmailBody() - æˆåŠŸ");
  console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
  return htmlBody;
}
